<Window x:Class="WPF2.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:WPF2"
        mc:Ignorable="d"
        Title="MainWindow" Height="800" Width="480"
        MinWidth="240" MinHeight="420"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <Style x:Key="MessageText" TargetType="TextBlock">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Focusable" Value="False" />
            <Setter Property="IsHitTestVisible" Value="True"/>
        </Style>

        <Style x:Key="ClientMessageStyle" TargetType="ListViewItem">
            <Setter Property="Focusable" Value="False"></Setter>
            <Setter Property="VerticalAlignment" Value="Top"></Setter>
            <Setter Property="IsHitTestVisible" Value="False"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsFromClient}" Value="false">
                    <Setter Property="HorizontalAlignment" Value="Left"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsFromClient}" Value="true">
                    <Setter Property="HorizontalAlignment" Value="Right"></Setter>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="SystemMessageStyle" TargetType="ListViewItem">
            <Setter Property="Focusable" Value="False"></Setter>
            <Setter Property="VerticalAlignment" Value="Top"></Setter>
            <Setter Property="HorizontalAlignment" Value="Center"></Setter>
            <Setter Property="IsHitTestVisible" Value="False"/>
        </Style>

        <Style x:Key="TimestampStyle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="Gray"/>
            <Setter Property="FontSize" Value="5"/>
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>

        <DataTemplate x:Key="ClientMessageTemplate" DataType="ListViewItem">
            <Border Background="DarkOrange" CornerRadius="8" 
                    Margin="20, 2"
                    HorizontalAlignment="Stretch"
                    ToolTip="{Binding Timestamp}">
                <StackPanel Orientation="Vertical">
                    <TextBlock FontWeight="Bold" 
                               Style="{StaticResource ResourceKey=MessageText}"
                               Text="{Binding Sender.Username}"
                               Margin="4,2">
                    </TextBlock>
                    <TextBlock Style="{StaticResource ResourceKey=MessageText}"
                               HorizontalAlignment="Center"
                               Text="{Binding MessageContent}"
                               Margin="4,2"
                               TextWrapping="Wrap">
                    </TextBlock>
                    <TextBlock Style="{StaticResource ResourceKey=TimestampStyle}"
                               Text="{Binding TimestampDisplay}"
                               Margin="4,2">
                    </TextBlock>
                </StackPanel>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="SystemMessageTemplate" DataType="ListViewItem">
            <TextBlock Foreground="DarkGray" FontWeight="Bold" Margin="4,2">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Setter Property="Text" Value="{Binding MessageContent}"/>
                        <!--Style.Triggers>
                            <DataTrigger Binding="{Binding Sender.Status}" Value="true">
                                <Setter Property="Text" Value="{Binding MessageContent}"></Setter>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Sender.Status}" Value="false">
                                <Setter Property="Text" Value="{Binding MessageContent}"></Setter>
                            </DataTrigger>
                        </Style.Triggers-->
                    </Style>
                </TextBlock.Style>
            </TextBlock>
        </DataTemplate>

        <local:MessageDataTemplateSelector x:Key="MessageDataTemplateSelector"
        ClientMessageTemplate="{StaticResource ClientMessageTemplate}"
        SystemMessageTemplate="{StaticResource SystemMessageTemplate}"/>
        <local:MessageStyleSelector x:Key="MessageStyleSelector"
         ClientMessageStyle="{StaticResource ClientMessageStyle}"  
         SystemMessageStyle="{StaticResource SystemMessageStyle}"/>
    </Window.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"></RowDefinition>
            <RowDefinition Height="*"></RowDefinition>
            <RowDefinition Height="Auto"></RowDefinition>
        </Grid.RowDefinitions>
        <Menu Grid.Row="0">
            <MenuItem Header="File">
                <MenuItem Name="ConnectMenuItem" Header="Connect" Click="User_Connect" IsEnabled="True"></MenuItem>
                <MenuItem Name="DisconnectMenuItem" Header="Disconnect" Click="User_Disconnect" IsEnabled="False"></MenuItem>
                <MenuItem Header="Exit" Click="App_Exit"></MenuItem>
            </MenuItem>
            <MenuItem Header="Help">
                <MenuItem Header="About" Click="Show_MessageBox"></MenuItem>
            </MenuItem>
        </Menu>
        <ScrollViewer VerticalScrollBarVisibility="Auto" Grid.Row="1">
            <ListView     Grid.Row="1"
                          HorizontalContentAlignment="Stretch"
                          ItemsSource="{Binding Messages}"
                          ItemTemplateSelector="{StaticResource ResourceKey=MessageDataTemplateSelector}"
                          ItemContainerStyleSelector="{StaticResource ResourceKey=MessageStyleSelector}"
                          AlternationCount="2"
                          Focusable="False"
                          BorderThickness="0">
            </ListView>
        </ScrollViewer>
        <Grid Grid.Row="2" Margin="0,0,0,2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto">
                </RowDefinition>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="6*"></ColumnDefinition>
                <ColumnDefinition Width="*"></ColumnDefinition>
            </Grid.ColumnDefinitions>
            <ScrollViewer Margin="10" Grid.Row="0" Grid.Column="0" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Disabled">
                <TextBox Name ="InputTextBox" Height="Auto" TextWrapping="Wrap" AcceptsReturn="True" PreviewKeyDown="KeyDownHandler" MaxHeight="100">
                </TextBox>
            </ScrollViewer>
            <Button Margin="0,10,10,10"
                    Grid.Row="0"
                    Grid.Column="1"
                    Height="Auto"
                    Click="SendMessage">Send</Button>
        </Grid>
    </Grid>
</Window>
